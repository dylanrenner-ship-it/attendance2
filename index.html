<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker Pro</title>
    <meta name="description" content="Track student attendance points automatically.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden { display: none !important; }
        /* Smooth scrolling for the table */
        html { scroll-behavior: smooth; }
        /* Custom scrollbar for table */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans min-h-screen">

    <header class="bg-indigo-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="graduation-cap" class="w-8 h-8 text-indigo-200"></i>
                <div>
                    <h1 class="font-bold text-xl leading-none">Attendance<span class="text-indigo-200">Tracker</span></h1>
                    <p class="text-xs text-indigo-300 opacity-80">Accumulate Points Daily</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="clearDataBtn" class="flex items-center gap-2 text-xs font-bold bg-indigo-800 hover:bg-red-600 px-3 py-2 rounded transition-colors text-indigo-200 hover:text-white" title="Delete all saved data">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Reset Semester
                </button>
                <button id="downloadBtn" class="flex items-center gap-2 text-sm font-bold bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500">
                <h2 class="font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Add New Day
                </h2>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date of Attendance</label>
                    <input type="date" id="attendanceDate" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <div class="relative group cursor-pointer">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".csv">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center group-hover:bg-indigo-50 group-hover:border-indigo-400 transition-all">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2 group-hover:text-indigo-500"></i>
                        <p class="text-sm font-medium text-gray-600">Click to Upload CSV</p>
                    </div>
                </div>
                <p id="uploadStatus" class="text-xs text-center mt-2 text-gray-400 min-h-[1.5em]"></p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <i data-lucide="history" class="w-5 h-5 text-gray-600"></i> History Log
                </h2>
                <div id="historyLog" class="text-sm space-y-3 max-h-64 overflow-y-auto pr-2">
                    <p class="text-gray-400 italic text-center py-4">No uploads yet.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-center">
                    <div class="text-2xl font-bold text-blue-700" id="totalStudents">0</div>
                    <div class="text-xs text-blue-500 font-bold uppercase">Students</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center">
                    <div class="text-2xl font-bold text-green-700" id="grandTotalPoints">0</div>
                    <div class="text-xs text-green-500 font-bold uppercase">Total Pts Given</div>
                </div>
            </div>

        </div>

        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-md overflow-hidden min-h-[500px] flex flex-col">
                
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex items-center gap-4 sticky top-0">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                        <input type="text" id="searchInput" placeholder="Search student..." class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="text-xs text-gray-500 font-mono" id="lastUpdatedBadge">Not saved</div>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 text-gray-500 text-xs uppercase font-bold sticky top-0">
                            <tr>
                                <th class="px-6 py-3">Rank</th>
                                <th class="px-6 py-3">Student Name</th>
                                <th class="px-6 py-3 text-right">Accumulated Points</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody" class="divide-y divide-gray-100 text-sm">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">Loading saved data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const POINTS_MAP = {
            "": 10, "P": 10, "ADM": 10, "NEX": 10,
            "TEX": 8, "PEX": 8, "PEX-AE": 8,
            "EDUX": 7, "EDEX": 7,
            "AEX": 5, "M": 5, "B": 5, "I": 5, "T": 5, "1": 5, "TUX": 5, "RO": 5, "K1": 5, "CRT": 5, "OSF": 5, "GR": 5, "NM": 5,
            "PUX": 3,
            "AU": 0, "BUS": 0, "Y": 0, "ISS": 0, "S": 0, "R": 0, "EXP": 0
        };

        const STORAGE_KEY = "attendance_tracker_v2_data";

        // --- 2. STATE ---
        let appState = { students: {}, history: [] };

        // --- 3. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('attendanceDate').valueAsDate = new Date();
            loadData();
            lucide.createIcons();
        });

        // --- 4. CORE LOGIC ---
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { appState = JSON.parse(saved); } catch (e) { console.error("Save file corrupted", e); }
            }
            renderUI();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
            renderUI();
        }

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const selectedDate = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerText = "Processing...";
            statusEl.className = "text-xs text-center mt-2 text-indigo-600 font-bold";

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split('\n');
                
                let processedCount = 0;
                let pointsAddedForBatch = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    let row = [];
                    if (line.includes('"')) {
                        row = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                        row = row.map(cell => cell.replace(/^"|"$/g, '').trim());
                    } else {
                        row = line.split(',').map(item => item.trim());
                    }

                    if (row.length >= 2) {
                        const name = row[0]; 
                        const code = (row[1] || "").toUpperCase();
                        const points = POINTS_MAP.hasOwnProperty(code) ? POINTS_MAP[code] : 0;

                        if (!appState.students[name]) appState.students[name] = 0;
                        appState.students[name] += points;

                        processedCount++;
                        pointsAddedForBatch += points;
                    }
                }

                appState.history.unshift({
                    date: selectedDate,
                    fileName: file.name,
                    count: processedCount,
                    totalPoints: pointsAddedForBatch,
                    timestamp: new Date().toLocaleString()
                });

                saveData();
                event.target.value = ''; 
                statusEl.innerText = "Success! Added points.";
                statusEl.className = "text-xs text-center mt-2 text-green-600 font-bold";
                setTimeout(() => statusEl.innerText = "", 3000);
            };
            reader.readAsText(file);
        });

        function clearAllData() {
            if(confirm("ARE YOU SURE?\nThis will delete all student records and history from this browser.\nThis cannot be undone.")) {
                localStorage.removeItem(STORAGE_KEY);
                appState = { students: {}, history: [] };
                renderUI();
            }
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderUI() {
            renderTable();
            renderHistory();
            renderStats();
            lucide.createIcons();
        }

        function renderStats() {
            const names = Object.keys(appState.students);
            const totalPoints = Object.values(appState.students).reduce((a,b) => a+b, 0);
            document.getElementById('totalStudents').innerText = names.length;
            document.getElementById('grandTotalPoints').innerText = totalPoints;
            document.getElementById('lastUpdatedBadge').innerText = "Auto-saved to Browser";
        }

        function renderHistory() {
            const container = document.getElementById('historyLog');
            container.innerHTML = "";
            if (appState.history.length === 0) {
                container.innerHTML = `<p class="text-gray-400 italic text-center py-4">No uploads yet.</p>`;
                return;
            }
            appState.history.forEach(log => {
                const div = document.createElement('div');
                div.className = "p-3 bg-gray-50 rounded border-l-4 border-indigo-400 text-xs";
                div.innerHTML = `
                    <div class="flex justify-between font-bold text-gray-700">
                        <span>${log.date}</span>
                        <span>+${log.totalPoints} pts</span>
                    </div>
                    <div class="text-gray-500 mt-1 flex justify-between">
                        <span>${log.fileName}</span>
                        <span>${log.count} students</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderTable(searchTerm = "") {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = "";
            let studentsArray = Object.entries(appState.students).map(([name, total]) => ({ name, total }));
            studentsArray.sort((a, b) => b.total - a.total);

            if (searchTerm) {
                studentsArray = studentsArray.filter(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));
            }

            if (studentsArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-gray-400 italic">No data found. Upload a CSV to begin.</td></tr>`;
                return;
            }

            studentsArray.forEach((student, index) => {
                let badgeClass = "bg-gray-100 text-gray-800";
                if (student.total > 500) badgeClass = "bg-purple-100 text-purple-800";
                else if (student.total > 250) badgeClass = "bg-green-100 text-green-800";
                else if (student.total > 100) badgeClass = "bg-blue-100 text-blue-800";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50/30 transition-colors group";
                tr.innerHTML = `
                    <td class="px-6 py-4 text-gray-400 font-mono text-xs">#${index + 1}</td>
                    <td class="px-6 py-4 font-bold text-gray-700 group-hover:text-indigo-700">${student.name}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${badgeClass}">
                            ${student.total}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => renderTable(e.target.value));
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const studentsArray = Object.entries(appState.students).map(([name, total]) => ({ name, total }));
            studentsArray.sort((a, b) => b.total - a.total);
            let csv = "Rank,Student Name,Total Accumulated Points\n";
            studentsArray.forEach((s, i) => { csv += `${i+1},"${s.name}",${s.total}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Attendance_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });
    </script>
</body>
</html>
